# 모던 리액트 Deep Dive 스터디 week3

## 리액트 핵심 요소 깊게 살펴보기: 컴포넌트와 함수의 무거운 연산을 기억해 두는 메모이제이션

리액트에서 제공하는 API 중 useMemo, useCallback 훅과 고차 컴포넌트인 memo는 리액트에서 발생하는 렌더링을 최소한으로 줄이기 위해서 제공된다. 즉, 이러한 메모이제이션 기법이 최적화 기법으로 사용되는데, 언제 사용하는 것이 좋을지가 문제이다. 이것은 아직도 갑론을박이 이어지는 오랜 논쟁 주제라고 하는데, 무조건 메모이제이션이 필요하다는 쪽과 메모이제이션을 섣불리 해서는 안 된다는 쪽이 있다.

하지만 만약 깊이 들여다볼 시간이나 그럴만한 여유가 없을 때는 의심스러운 곳에는 일단 다 적용해보는 것도 나쁘지 않다고 생각합니다.

이 외의 성능 향상 방법으로는 컴포넌트 mapping 시 key 값으로 꼭 고유 key를 쓰는 것과 useState 관련하여 무거운 연산이 요구 될 때 함수 형태로 인수에 넘겨줌으로써 lazy initialization이 일어나도록 하는 것도 방법일 것이라고 생각됩니다.

### 주장 1: 섣부른 최적화는 독이다. 꼭 필요한 곳에만 메모이제이션을 추가하자.

꼭 필요한 곳을 신중히 골라서 메모이제이션해야 한다는 입장이다. 메모이제이션도 어디까지나 메모리 등의 비용이 드는 작업이므로 최적화에 대한 비용을 지불 할 때는 항상 신중해야 한다고 생각하는 것이다. 그리고 아주 가벼운 작업 자체는 메모이제이션해서 자바스크립트 메모리 어딘가에 두었다가 그것을 다시 꺼내오는 것보다는 매번 이 작업을 수행해 결과를 반환하는 것이 더 빠를 수도 있다. <br/>
값을 비교하고 렌더링 또는 재계산이 필요한지 확인하는 작업과 이전에 결과물을 저장해 두었다가 다시 꺼내와야하는 두 가지 비용이 있기 때문에 신중해야 한다. 그렇기에 섣부른 최적화(`premature optimization`)는 경계해야 한다. 메모이제이션은 이렇듯 어느 정도의 트레이드 오프가 있는 기법이므로 애플리케이션을 어느 정도 만든 이후에 개발자 도구나 useEffect를 사용해 어떻게 렌더링이 일어나고 있는지 확인하고 필요한 곳에 useMemo, useCallback 훅과 고차 컴포넌트인 memo 등을 써서 최적화하는 것이 옳다.

### 주장 2: 렌더링 과정의 비용은 비싸다. 모조리 메모이제이션해 버리자.

두 가지 주장에서 모두 공통으로 깔고 가는 전제는 다음과 같다. 일부 컴포넌트에서는 메모이제이션을 하는 것이 성능에 도움이 된다. 섣부른 최적화인지 여부와는 관계없이, 만약 해당 컴포넌트가 렌더링이 자주 일어나며 그 렌더링 사이에 비싼 연산이 포함돼 있고, 심지어 그 컴포넌트가 자식 컴포넌트 또한 많이 가지고 있다면 memo나 다른 메모이제이션 방법을 사용하는 것이 이점이 있을 때가 분명히 있다.

그렇다면 우린 두 가지 선택권이 있다.

- memo를 컴포넌트의 사용에 따라 잘 살펴보고 일부에만 적용
- memo를 일단 그냥 다 적용

첫 번째 경우는 가장 이상적인 상황이지만, 최적화나 성능에 쏟을 시간이 많지 않다는 것이 사실이다. 그렇다면 우선 memo로 감싸본 뒤에 렌더링 비용이 저렴한 컴포넌트일 경우 역으로 지불해야 하는 비용을 생각해 보자. 잘못된 memo로 지불해야 하는 비용은 바로 props에 대한 얕은 비교가 발생하면서 지불해야 하는 비용이다. 그리고 메모이제이션을 위해서는 CPU와 메모리를 사용해 이전 렌더링 결과물을 저장해 둬야 하고, 리렌더링할 필요가 없다면 이전 결과물을 사용해야 한다. 이는 어떻게 보면 리액트의 재조정 알고리즘과 동일하다고도 볼 수 있다. 따라서, 우리가 memo로 지불하는 비용은 props에 대한 얕은 비교뿐인 것이다. <br/>

반면 memo를 하지 않았을 때 발생할 수 있는 문제는 다음과 같다.

- 렌더링을 함으로써 발생하는 비용
- 컴포넌트 내부의 복잡한 로직의 재실행
- 그리고 위 두 가지 모두가 모든 자식 컴포넌트에서 반복해서 일어남
- 리액트가 구 트리와 신규 트리를 비교

얼핏 보더라도 memo를 하지 않았을 때 치러야 할 잠재적인 위험 비용이 더 크다는 것이다. useMemo와 useCallback 관련해서도 메모이제이션은 컴포넌트 자신의 리렌더링뿐만 아니라 이를 사용하는 쪽에서도 변하지 않는 고정된 값을 사용할 수 있다는 믿음을 줄 수 있다. 정리하자면, 메모이제이션은 하지 않는 것보다 메모이제이션했을 때 더 많은 이점을 누릴 수 있다. 최적화에 대한 확신이 없다면 가능한 한 모든 곳에 메모이제이션을 활용한 최적화를 하는 것이 좋다.

### 결론

리액트를 배우고 있거나 리액트를 깊이 이해하고 싶고, 이를 위해 시간을 투자할 여유가 있다면 섣부른 메모이제이션을 지양하는 자세를 견지하면서 실제 어느 지점에서 성능상 이점을 누릴 수 있는지 살펴보는 식으로 메모이제이션을 적용하는 것이 권장된다. 만약 현업에서 리액트를 사용하고 있거나 실제로 다룰 예정이지만 성능에 대해 깊게 연구해 볼 시간이 없다면 일단 의심스러운 곳에 먼저 다 적용해 볼 것이 권장된다.
